{% extends 'base.html' %}
{% load static %}

{% block title %}Employee List{% endblock %}

{% block content %}
<div class="pagetitle">
  <h1>Employee List</h1>
  <nav>
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Home</a></li>
      <li class="breadcrumb-item active">Employee</li>
    </ol>
  </nav>
</div>

<section class="section">
  <div class="row">
    <div class="col-lg-12">

      <div class="card border border-primary">
        <div class="card-body p-4">

          <!-- Header -->
          <div class="d-lg-flex align-items-center mb-3">
            <h5 class="card-title mb-0">List of Employees</h5>
            <div class="ms-auto">
              <a href="{% url 'employee_add' %}" class="btn btn-success">
                <i class="bi bi-plus-circle me-1"></i> Add Employee
              </a>
            </div>
          </div>

          <!-- Filter Section -->
          <form method="get" class="row g-3 align-items-end mb-4">
            <div class="col-md-3">
              <label for="date_from" class="form-label">From Date</label>
              <input type="date" id="date_from" name="date_from" class="form-control"
                     value="{{ request.GET.date_from }}">
            </div>
            <div class="col-md-3">
              <label for="date_to" class="form-label">To Date</label>
              <input type="date" id="date_to" name="date_to" class="form-control"
                     value="{{ request.GET.date_to }}">
            </div>
            <div class="col-md-3">
              <button type="submit" class="btn btn-primary w-100">
                <i class="bi bi-funnel me-1"></i> Filter
              </button>
            </div>
          </form>

          <!-- Table -->
          <form method="post" action="{% url 'download_selected' %}" id="downloadForm">
            {% csrf_token %}
            <div class="d-flex justify-content-end mb-3">
              <button type="submit" class="btn btn-outline-info" id="downloadSelected" disabled>
                <i class="bi bi-download me-1"></i> Download Selected
              </button>
            </div>

            <div class="table-responsive">
              
              <table id="myTable" class="table table-striped table-bordered align-middle">
                <thead class="table-primary">
                  <tr>
                    <th scope="col" class="text-md dt-nowrap">
                      <input type="checkbox" id="selectAll"> Sl.No
                    </th>
                    <th>Actions</th>
                    <th>Employee No</th>
                    <th>Name</th>
                    <th>Phone</th>
                    <th>Department</th>
                    <th>Designation</th>
                    <th>Location</th>
                    <th>Skills</th>
                  </tr>
                </thead>
                <tbody>
                  {% for emp in employees %}
                  <tr>
                    <td class="dt-nowrap align-middle text-center">
                      <label class="d-inline-flex align-items-center mb-0">
                        <input type="checkbox" class="form-check-input rowCheckbox me-2" value="{{ emp.id }}">
                        <span class="fw-semibold">{{ forloop.counter }}</span>
                      </label>
                    </td>

                    <td>
                      <div class="d-flex gap-2">
                        <a href="{% url 'employee_edit' emp.id %}" class="btn btn-outline-info btn-sm" title="Edit">
                          <i class="bi bi-pencil-fill"></i>
                        </a>
                        <a href="{% url 'employee_detail' emp.id %}" class="btn btn-outline-success btn-sm" title="View">
                          <i class="bi bi-eye-fill"></i>
                        </a>
                        <button type="button" class="btn btn-outline-danger btn-sm" title="Delete"
                                data-bs-toggle="modal" data-bs-target="#deleteModal{{ emp.id }}">
                          <i class="bi bi-trash-fill"></i>
                        </button>
                      </div>

                      <!-- Delete Modal -->
                      <div class="modal fade" id="deleteModal{{ emp.id }}" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                          <div class="modal-content">
                            <div class="modal-header bg-danger text-white">
                              <h5 class="modal-title">Delete Employee</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                              Are you sure you want to delete <strong>{{ emp.name }}</strong>?
                              <br><small class="text-muted">This action cannot be undone.</small>
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                              <form method="post" action="{% url 'employee_delete' emp.id %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-danger">Confirm Delete</button>
                              </form>
                            </div>
                          </div>
                        </div>
                      </div>
                    </td>
                    <td>{{ emp.empno }}</td>
                    <td>{{ emp.name }}</td>
                    <td>{{ emp.phone|default:"—" }}</td>
                    <td>{{ emp.department }}</td>
                    <td>{{ emp.designation }}</td>
                    <td>{{ emp.location }}</td>
                    <td>
                      {% if emp.skills %}
                        {{ emp.skills }}
                      {% else %}
                        —
                      {% endif %}
                    </td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="10" class="text-center text-muted">No Employees Found</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </form>
        </div>
      </div>

    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="{% static 'assets/js/jquery-3.5.1.js' %}"></script>
<script src="{% static 'assets/js/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'assets/js/dataTables.responsive.min.js' %}"></script>

<script>
$(document).ready(function() {
  // Initialize DataTable
  $('#myTable').DataTable({
    responsive: true,
    pageLength: 10
  });

  // Select All
  $('#selectAll').on('click', function() {
    $('.rowCheckbox').prop('checked', this.checked);
    toggleDownloadButton();
  });

  // Enable Download Button if any checkbox selected
  $('.rowCheckbox').on('change', function() {
    toggleDownloadButton();
  });

  function toggleDownloadButton() {
    let selected = $('.rowCheckbox:checked').length > 0;
    $('#downloadSelected').prop('disabled', !selected);
  }

  // On Submit - Collect Selected IDs
  $('#downloadForm').on('submit', function(e) {
    e.preventDefault();
    let ids = $('.rowCheckbox:checked').map(function() {
      return this.value;
    }).get().join(',');

    if (!ids) {
      alert("Please select at least one employee.");
      return false;
    }

    // Create hidden input and submit
    $('<input>').attr({
      type: 'hidden',
      name: 'ids',
      value: ids
    }).appendTo('#downloadForm');

    this.submit();
  });
});
</script>
{% endblock %}
{% block extra_scripts %}
<!-- jQuery (only once) -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<!-- DataTables -->
<script src="{% static 'assets/js/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'assets/js/dataTables.responsive.min.js' %}"></script>

<!-- Select2 -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- Your custom script -->
<script src="{% static 'assets/js/main.js' %}"></script>

<script>
$(document).ready(function() {
  // Initialize DataTable
  $('#myTable').DataTable({
    responsive: true,
    pageLength: 10
  });

  //  Initialize Select2 safely
  if ($.fn.select2) {
    $('select').select2({
      width: '100%',
      placeholder: "Select an option"
    });
  }

  // Select All
  $('#selectAll').on('click', function() {
    $('.rowCheckbox').prop('checked', this.checked);
    toggleDownloadButton();
  });

  $('.rowCheckbox').on('change', toggleDownloadButton);

  function toggleDownloadButton() {
    let selected = $('.rowCheckbox:checked').length > 0;
    $('#downloadSelected').prop('disabled', !selected);
  }

  // On Submit - Collect Selected IDs
  $('#downloadForm').on('submit', function(e) {
    e.preventDefault();
    let ids = $('.rowCheckbox:checked').map(function() {
      return this.value;
    }).get().join(',');

    if (!ids) {
      alert("Please select at least one employee.");
      return false;
    }

    $('<input>').attr({
      type: 'hidden',
      name: 'ids',
      value: ids
    }).appendTo('#downloadForm');

    this.submit();
  });
});
</script>
{% endblock %}
